<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>AR Tracing ‚Äì C√¢mera + Desenho Sobreposto</title>
  <style>
    :root {
      --ui-bg: rgba(20,22,28,0.72);
      --ui-fg: #e8eaed;
      --accent: #6ee7b7;
    }
    html, body { height: 100%; margin: 0; background: #000; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #app { position: fixed; inset: 0; overflow: hidden; }

    /* Camadas */
    .layer { position: absolute; inset: 0; }
    #video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(1); }
    #overlayWrapper { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%) scale(1) rotate(0deg); touch-action: none; }
    #overlay { display: block; max-width: 90vw; max-height: 90vh; opacity: 0.5; pointer-events: none; user-select: none; }

    /* UI */
    #controls { position: absolute; left: 0; right: 0; bottom: 0; padding: 10px; display: grid; gap: 8px; background: linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.35) 25%, rgba(0,0,0,.6)); }
    .card { background: var(--ui-bg); color: var(--ui-fg); border-radius: 14px; padding: 10px; backdrop-filter: blur(7px); box-shadow: 0 4px 20px rgba(0,0,0,.35); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
    label { font-size: 12px; opacity: .9; }
    input[type="range"] { width: 100%; }
    input[type="file"], input[type="text"] { width: 100%; }
    button { cursor: pointer; background: #111827; color: var(--ui-fg); border: 1px solid #30363d; padding: 10px 12px; border-radius: 12px; font-weight: 600; }
    button.primary { background: #0b4; border-color: #0b4; }
    button.ghost { background: transparent; }
    button:active { transform: translateY(1px); }
    .thin { font-weight: 500; opacity: .9; }
    .pill { display: inline-flex; gap: 6px; align-items: center; padding: 8px 10px; border-radius: 999px; background: #0b0b0b; border: 1px solid #2a2a2a; }
    .spaced { display: flex; gap: 8px; flex-wrap: wrap; }

    #topbar { position: absolute; top: 8px; left: 8px; right: 8px; display: flex; gap: 8px; flex-wrap: wrap; }

    /* Dicas flutuantes */
    #hint { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; background: rgba(0,0,0,.45); padding: 10px 14px; border-radius: 10px; text-align: center; display: none; }

    @media (min-width: 720px) {
      #controls { max-width: 860px; margin: 0 auto; }
      #topbar { max-width: 860px; margin: 0 auto; left: 0; right: 0; }
    }
  </style>
</head>
<body>
  <div id="app">
    <video id="video" class="layer" autoplay playsinline muted></video>

    <!-- Imagem sobreposta -->
    <div id="overlayWrapper" class="layer" aria-label="√Årea da imagem sobreposta">
      <img id="overlay" alt="Desenho sobreposto" />
    </div>

    <!-- Topbar: c√¢mera/vis√£o -->
    <div id="topbar">
      <div class="pill"><span>üé•</span><span class="thin" id="camStatus">C√¢mera parada</span></div>
      <div class="spaced">
        <button id="btnStart" class="primary">Abrir c√¢mera (traseira)</button>
        <button id="btnSwitch">Trocar c√¢mera</button>
        <button id="btnFullscreen" class="ghost">Tela cheia</button>
        <button id="btnWake" class="ghost">Manter tela ligada</button>
        <button id="btnMirror" class="ghost">Espelhar v√≠deo</button>
      </div>
    </div>

    <!-- Controles -->
    <div id="controls">
      <div class="card">
        <div class="row">
          <div>
            <label for="file">Imagem sobreposta (PNG recomendado):</label>
            <input id="file" type="file" accept="image/*" />
          </div>
          <div>
            <label for="imgUrl">‚Ä¶ou URL da imagem:</label>
            <div style="display:flex; gap:6px;">
              <input id="imgUrl" type="text" placeholder="https://‚Ä¶/desenho.png" />
              <button id="btnLoadUrl">Carregar</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row3">
          <div>
            <label for="opacity">Opacidade: <span id="opacityVal">0.50</span></label>
            <input id="opacity" type="range" min="0" max="1" step="0.01" value="0.5" />
          </div>
          <div>
            <label for="scale">Tamanho (zoom): <span id="scaleVal">1.00√ó</span></label>
            <input id="scale" type="range" min="0.2" max="3" step="0.01" value="1" />
          </div>
          <div>
            <label for="rotate">Rota√ß√£o: <span id="rotateVal">0¬∞</span></label>
            <input id="rotate" type="range" min="-180" max="180" step="1" value="0" />
          </div>
        </div>
        <div class="spaced" style="margin-top:8px;">
          <button id="btnFlipH">Inverter horizontal</button>
          <button id="btnFlipV">Inverter vertical</button>
          <button id="btnBlend">Mistura: normal</button>
          <button id="btnReset">Resetar</button>
          <button id="btnCenter">Centralizar</button>
        </div>
      </div>

      <div class="card">
        <div class="spaced">
          <span class="thin">Arraste com um dedo para mover. Use pin√ßa (2 dedos) para zoom/rota√ß√£o do desenho.</span>
        </div>
      </div>
    </div>

    <div id="hint">Dica: fixe o celular no trip√© acima do papel. Ajuste o zoom e a opacidade at√© o tra√ßo ficar confort√°vel.</div>
  </div>

  <script>
    // --------- Utilidades ----------
    const $ = sel => document.querySelector(sel);
    const video = $('#video');
    const overlayWrapper = $('#overlayWrapper');
    const overlay = $('#overlay');
    const camStatus = $('#camStatus');

    let currentStream = null;
    let devices = [];
    let deviceIndex = 0;
    let wakeLock = null;

    const state = {
      x: 0, y: 0, scale: 1, rotate: 0, flipH: 1, flipV: 1, opacity: 0.5, blend: 'normal',
    };

    function applyTransform() {
      overlayWrapper.style.transform = `translate(calc(50% + ${state.x}px), calc(50% + ${state.y}px)) scale(${state.scale}) rotate(${state.rotate}deg)`;
      overlay.style.transform = `scale(${state.flipH}, ${state.flipV})`;
      overlay.style.opacity = state.opacity;
      overlay.style.mixBlendMode = state.blend;
      $('#opacityVal').textContent = state.opacity.toFixed(2);
      $('#scaleVal').textContent = state.scale.toFixed(2) + '√ó';
      $('#rotateVal').textContent = Math.round(state.rotate) + '¬∞';
      localStorage.setItem('arTracingState', JSON.stringify(state));
    }

    function restoreState() {
      const saved = localStorage.getItem('arTracingState');
      if (!saved) return;
      try {
        const s = JSON.parse(saved);
        Object.assign(state, s);
        $('#opacity').value = state.opacity;
        $('#scale').value = state.scale;
        $('#rotate').value = state.rotate;
        applyTransform();
      } catch {}
    }

    // --------- C√¢mera ----------
    async function listCameras() {
      try {
        const all = await navigator.mediaDevices.enumerateDevices();
        devices = all.filter(d => d.kind === 'videoinput');
      } catch (e) {
        console.warn('enumerateDevices falhou', e);
      }
    }

    async function startCamera({ facingMode = 'environment', deviceId = null } = {}) {
      stopCamera();
      const constraints = deviceId ? { video: { deviceId: { exact: deviceId } } } : { video: { facingMode } };
      try {
        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = currentStream;
        camStatus.textContent = 'C√¢mera ativa';
        $('#hint').style.display = 'block';
        await listCameras();
      } catch (err) {
        camStatus.textContent = 'Falha ao abrir c√¢mera';
        alert('N√£o foi poss√≠vel acessar a c√¢mera. Verifique permiss√µes e conex√£o HTTPS.\n\nDetalhes: ' + err.message);
        console.error(err);
      }
    }

    function stopCamera() {
      if (currentStream) {
        currentStream.getTracks().forEach(t => t.stop());
        currentStream = null;
        camStatus.textContent = 'C√¢mera parada';
      }
    }

    async function switchCamera() {
      if (!devices.length) await listCameras();
      if (!devices.length) return alert('Nenhuma c√¢mera encontrada.');
      deviceIndex = (deviceIndex + 1) % devices.length;
      const chosen = devices[deviceIndex];
      startCamera({ deviceId: chosen.deviceId });
    }

    // --------- Wake Lock ----------
    async function toggleWakeLock() {
      try {
        if (!wakeLock) {
          wakeLock = await navigator.wakeLock.request('screen');
          $('#btnWake').textContent = 'Tela ligada ‚úî';
          wakeLock.addEventListener('release', () => { $('#btnWake').textContent = 'Manter tela ligada'; wakeLock = null; });
        } else {
          wakeLock.release();
          wakeLock = null;
          $('#btnWake').textContent = 'Manter tela ligada';
        }
      } catch (e) {
        alert('Wake Lock n√£o suportado neste navegador.');
      }
    }

    // --------- Fullscreen ----------
    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(() => {});
      } else {
        document.exitFullscreen();
      }
    }

    // --------- Espelhar v√≠deo ----------
    let mirrored = false;
    function toggleMirror() {
      mirrored = !mirrored;
      video.style.transform = `scaleX(${mirrored ? -1 : 1})`;
    }

    // --------- Carregar imagem ----------
    $('#file').addEventListener('change', e => {
      const f = e.target.files?.[0];
      if (!f) return;
      const url = URL.createObjectURL(f);
      overlay.src = url;
      overlay.onload = () => URL.revokeObjectURL(url);
    });
    $('#btnLoadUrl').addEventListener('click', () => {
      const url = $('#imgUrl').value.trim();
      if (!url) return;
      overlay.src = url;
    });

    // --------- Sliders ----------
    $('#opacity').addEventListener('input', e => { state.opacity = parseFloat(e.target.value); applyTransform(); });
    $('#scale').addEventListener('input', e => { state.scale = parseFloat(e.target.value); applyTransform(); });
    $('#rotate').addEventListener('input', e => { state.rotate = parseFloat(e.target.value); applyTransform(); });

    // --------- Bot√µes ----------
    $('#btnStart').addEventListener('click', () => startCamera({ facingMode: 'environment' }));
    $('#btnSwitch').addEventListener('click', switchCamera);
    $('#btnFullscreen').addEventListener('click', toggleFullscreen);
    $('#btnWake').addEventListener('click', toggleWakeLock);
    $('#btnMirror').addEventListener('click', toggleMirror);
    $('#btnFlipH').addEventListener('click', () => { state.flipH *= -1; applyTransform(); });
    $('#btnFlipV').addEventListener('click', () => { state.flipV *= -1; applyTransform(); });
    $('#btnBlend').addEventListener('click', () => {
      const modes = ['normal', 'multiply', 'screen', 'overlay', 'darken', 'lighten'];
      const i = modes.indexOf(state.blend);
      state.blend = modes[(i + 1) % modes.length];
      $('#btnBlend').textContent = 'Mistura: ' + state.blend;
      applyTransform();
    });
    $('#btnReset').addEventListener('click', () => {
      Object.assign(state, { x:0, y:0, scale:1, rotate:0, flipH:1, flipV:1, opacity:0.5, blend:'normal' });
      $('#opacity').value = state.opacity; $('#scale').value = state.scale; $('#rotate').value = state.rotate;
      applyTransform();
    });
    $('#btnCenter').addEventListener('click', () => { state.x = 0; state.y = 0; applyTransform(); });

    // --------- Gestos (arrastar, zoom, rota√ß√£o) ----------
    let last = { x: 0, y: 0 };
    let touches = [];

    function setWrapperPos(dx, dy) {
      state.x += dx; state.y += dy; applyTransform();
    }

    function distance(a, b) { const dx = a.clientX - b.clientX, dy = a.clientY - b.clientY; return Math.hypot(dx, dy); }
    function angle(a, b) { return Math.atan2(b.clientY - a.clientY, b.clientX - a.clientX) * 180 / Math.PI; }

    overlayWrapper.addEventListener('pointerdown', (e) => {
      overlayWrapper.setPointerCapture(e.pointerId);
      touches = [e];
      last.x = e.clientX; last.y = e.clientY;
    });

    overlayWrapper.addEventListener('pointermove', (e) => {
      if (!touches.length) return;
      if (touches.length === 1) {
        const dx = e.clientX - last.x; const dy = e.clientY - last.y;
        setWrapperPos(dx, dy);
        last.x = e.clientX; last.y = e.clientY;
      }
    });

    overlayWrapper.addEventListener('pointerup', (e) => { touches = []; });
    overlayWrapper.addEventListener('pointercancel', () => { touches = []; });

    // Suporte a gesto de pin√ßa/rota√ß√£o com 2 dedos via eventos de toque
    let pinchStart = null;
    overlayWrapper.addEventListener('touchstart', (e) => {
      if (e.touches.length === 2) {
        const [a, b] = e.touches; pinchStart = {
          dist: distance(a, b), ang: angle(a, b), scale: state.scale, rot: state.rotate
        };
      }
    }, { passive: true });

    overlayWrapper.addEventListener('touchmove', (e) => {
      if (e.touches.length === 2 && pinchStart) {
        const [a, b] = e.touches;
        const d = distance(a, b);
        const ang = angle(a, b);
        const scaleFactor = d / pinchStart.dist;
        state.scale = Math.min(3, Math.max(0.2, pinchStart.scale * scaleFactor));
        state.rotate = pinchStart.rot + (ang - pinchStart.ang);
        applyTransform();
      }
    }, { passive: true });

    overlayWrapper.addEventListener('touchend', () => { pinchStart = null; }, { passive: true });

    // Restaura estado salvo
    restoreState();

    // Carrega uma imagem placeholder opcional
    overlay.src = '';

    // Dicas de uso
    setTimeout(() => { $('#hint').style.display = 'none'; }, 6000);

    // Evita bloqueio de rolagem quando arrasta o overlay
    document.addEventListener('gesturestart', e => e.preventDefault());
  </script>
</body>
</html>
